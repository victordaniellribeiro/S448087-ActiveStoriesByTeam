<!DOCTYPE html>
<html>
<head>
    <title>S448087-ActiveStoriesByTeam</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",_projectId:void 0,_mapProjects:void 0,_releaseId:void 0,_releaseName:void 0,_iterationId:void 0,_iterationName:void 0,_includeDefects:!1,items:[{xtype:"container",itemId:"header",cls:"header"},{xtype:"container",itemId:"bodyContainer",width:"100%",autoScroll:!0}],launch:function(){var e=this.getContext().getProject().ObjectID;this._projectId=e,console.log("Project:",this._projectId),this.myMask=new Ext.LoadMask({msg:"Please wait...",target:this});var t=Ext.create("Rally.ui.combobox.ReleaseComboBox",{fieldLabel:"Choose Release",width:400,itemId:"releasaeComboBox",allowClear:!0,showArrows:!1,scope:this,listeners:{ready:function(e){var t=e.getRecord();this._releaseId=t.get("ObjectID"),this._releaseName=e.getRecord().get("Name")},select:function(e,t){var a=t[0];this._releaseId=a.get("ObjectID"),this._releaseName=e.getRecord().get("Name")},scope:this}}),a=Ext.create("Rally.ui.combobox.IterationComboBox",{fieldLabel:"Choose Iteration",width:400,itemId:"iterationComboBox",allowClear:!0,showArrows:!1,scope:this,listeners:{ready:function(e){var t=e.getRecord();this._iterationId=t.get("ObjectID"),this._iterationName=t.get("Name")},select:function(e,t,a){var o=t[0];this._iterationId=o.get("ObjectID"),this._iterationName=o.get("Name")},scope:this}}),o=Ext.create("Rally.ui.Button",{text:"Search",margin:"10 10 10 100",scope:this,handler:function(){this._doSearch()}});this.down("#header").add([{xtype:"panel",autoWidth:!0,layout:"hbox",items:[{xtype:"panel",title:"Filter:",flex:3,align:"stretch",autoHeight:!0,bodyPadding:10,items:[{xtype:"radiogroup",items:[{xtype:"radiofield",id:"radio1",name:"parameter",boxLabel:"Release",padding:"0 10 0 0",inputValue:"r"},{boxLabel:"Iteration",name:"parameter",padding:"0 10 0 0",inputValue:"i",id:"radio2"},{boxLabel:"All",name:"parameter",padding:"0 10 0 0",inputValue:"a",id:"radio3"}],listeners:{change:function(e,o,i){var r=o.parameter;this._searchParameter=r,console.log("value radio:",r),"r"==r?(t.show(),a.hide()):"i"==r?(t.hide(),a.show()):(t.hide(),a.hide())},scope:this}},{xtype:"fieldcontainer",defaultType:"checkboxfield",items:[{boxLabel:"Include Defects & TestSets",id:"include",name:"include",padding:"0 10 0 0",inputValue:"i",listeners:{change:function(e,t,a){var o=t;this._includeDefects=o,console.log("value check:",o)},scope:this}}]}]}]},{xtype:"panel",items:[t,a,o]}]),t.hide(),a.hide()},_doSearch:function(){this.myMask.show();var e=this._getTypes(),t=this._getFilter(),a=Ext.create("Rally.data.wsapi.artifact.Store",{models:e,fetch:["Name","FormattedID","Blocked","ScheduleState","Owner","Project"],limit:1/0,context:{project:"/project/"+this._projectId,projectScopeUp:!1,projectScopeDown:!0},sorters:[{property:"FormattedID",direction:"ASC"}]});t&&a.addFilter(t),a.load().then({success:function(e){console.log("records",e),this._mapProjects=new Ext.util.MixedCollection,_.each(e,function(e){var t=e.get("Project");this._mapProjects.containsKey(t.Name)?this._mapProjects.get(t.Name).push(e):(artifacts=[],artifacts.push(e),this._mapProjects.add(t.Name,artifacts))},this),console.log("projects",this._mapProjects);var t=[];this._mapProjects.eachKey(function(e,a){var o=new Ext.util.MixedCollection;_.each(a,function(e){var t,a=e.get("Owner");if(console.log("owner",a),t=a?a._refObjectName:"No Owner",o.containsKey(t))o.get(t).push(e);else{var i=[];i.push(e),o.add(t,i)}},this),t.push(o)},this),console.log(t),this.down("#bodyContainer").removeAll(!0),this._addPanel(t),this.myMask.hide()},scope:this})},_getTypes:function(){var e=["HierarchicalRequirement"];return this._includeDefects&&(e.push("Defect"),e.push("TestSet")),e},_getFilter:function(){var e;Ext.create("Rally.data.QueryFilter",{property:"Blocked",operator:"=",value:!1});if("r"==this._searchParameter)e=Ext.create("Rally.data.QueryFilter",{property:"Release.name",operator:"=",value:this._releaseName});else if("i"==this._searchParameter){e=Ext.create("Rally.data.QueryFilter",{property:"Iteration.Name",operator:"=",value:this._iterationName})}return e},_addPanel:function(e){var t=Ext.create("Ext.container.Container",{layout:{type:"hbox",align:"stretch",padding:5},width:"100%",autoScroll:!0});this.down("#bodyContainer").add(t),_.each(e,function(e){var a=e.first()[0].get("Project").Name;console.log(a);var o=this._createStore(e),i=this._createGrid(o);console.log("store",o.getCount());var r=Ext.create("Ext.panel.Panel",{title:a,autoScroll:!0,width:300,layout:{type:"vbox",align:"stretch",padding:5},padding:5,items:[i]});t.add(r)},this)},_createGrid:function(e){return console.log("creating grid for:",e),Ext.create("Rally.ui.grid.Grid",{viewConfig:{stripeRows:!0,enableTextSelection:!0},showRowActionsColumn:!1,showPagingToolbar:!1,enableEditing:!1,itemId:"iterationScoreGrid",store:e,columnCfgs:[{text:"Name",dataIndex:"name",flex:3},{text:"Stories In Progress",dataIndex:"count",flex:2},{text:"Blocked",dataIndex:"blocked",flex:2}]})},_createStore:function(e){var t=[];e.eachKey(function(e,a){var o=0,i=0;_.each(a,function(e){var t=e.get("ScheduleState");e.get("Blocked")?i+=1:"Defined"!==t&&"In-Progress"!==t||(o+=1)},this),(o>0||i>0)&&t.push({name:e,count:o,blocked:i})},this);var a=Ext.create("Ext.data.JsonStore",{fields:["name","count","blocked"]});return a.loadData(t),a}});

            Rally.launchApp('CustomApp', {
                name:"S448087-ActiveStoriesByTeam",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
